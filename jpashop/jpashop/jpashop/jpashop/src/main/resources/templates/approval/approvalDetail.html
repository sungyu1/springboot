<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>휴가 신청 결재</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/fontawesome-all.min.css}"/>
    <link rel="stylesheet" th:href="@{/css/main.css}"/>
    <link rel="stylesheet" th:href="@{/css/vacation-style.css}"/>
    <link rel="stylesheet" th:href="@{/css/approval-style.css}"/>
</head>
<body class="is-preload">

<!-- Wrapper -->
<div id="wrapper">

    <!-- Main -->
    <div id="main">
        <div class="inner">

            <!-- Header -->
            <header id="header">
                <a href="/index" class="logo"><strong>선한병원</strong></a>
            </header>

            <!-- Section: 휴가 신청 결재 -->
            <section>
                <header class="major">
                    <h2>휴가 신청 결재</h2>
                </header>

                <!-- 휴가 신청 정보 -->
                <div class="vacation-detail">
                    <h3>신청 정보</h3>
                    <table class="detail-table">
                                                 <tr>
                             <th>신청자</th>
                             <td th:text="${vacationRequest.applicant.name}"></td>
                             <th>부서</th>
                             <td th:text="${vacationRequest.applicant.deptCode != null ? vacationRequest.applicant.deptCode : '미지정'}"></td>
                         </tr>
                        <tr>
                            <th>휴가 종류</th>
                            <td th:text="${vacationRequest.vacationType}"></td>
                            <th>총 일수</th>
                            <td th:text="${vacationRequest.totalDays} + '일'"></td>
                        </tr>
                        <tr>
                            <th>시작일</th>
                            <td th:text="${#temporals.format(vacationRequest.startDate, 'yyyy-MM-dd')}"></td>
                            <th>종료일</th>
                            <td th:text="${#temporals.format(vacationRequest.endDate, 'yyyy-MM-dd')}"></td>
                        </tr>
                        <tr>
                            <th>신청 사유</th>
                            <td colspan="3" th:text="${vacationRequest.reason}"></td>
                        </tr>
                        <tr>
                            <th>신청일</th>
                            <td colspan="3" th:text="${#temporals.format(vacationRequest.submittedAt, 'yyyy-MM-dd HH:mm')}"></td>
                        </tr>
                    </table>
                </div>

                <!-- 결재 라인 -->
                <div class="approval-line-detail">
                    <h3>결재 라인</h3>
                    <table class="approval-table">
                        <thead>
                        <tr>
                            <th>단계</th>
                            <th>결재자</th>
                            <th>상태</th>
                            <th>결재일시</th>
                            <th>의견</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="step : ${approvalSteps}">
                                                         <td>
                                 <span th:switch="${step.stepOrder}">
                                     <span th:case="1">1단계 (대체자)</span>
                                     <span th:case="2">2단계 (부서장)</span>
                                     <span th:case="3">3단계 (인사담당)</span>
                                     <span th:case="*">기타</span>
                                 </span>
                             </td>
                            <td th:text="${step.approver.name}"></td>
                            <td>
                                <span class="status-badge status-pending" th:if="${step.status == 'PENDING'}">대기중</span>
                                <span class="status-badge status-approved" th:if="${step.status == 'APPROVED'}">승인</span>
                                <span class="status-badge status-rejected" th:if="${step.status == 'REJECTED'}">반려</span>
                            </td>
                            <td th:text="${step.approvedAt != null ? #temporals.format(step.approvedAt, 'yyyy-MM-dd HH:mm') : '-'}"></td>
                            <td th:text="${step.comment != null ? step.comment : '-'}"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 신청자 서명 -->
                <div class="signature-section" th:if="${vacationRequest.signatureImage}">
                    <h3>신청자 서명</h3>
                    <div class="signature-display">
                        <img th:src="${vacationRequest.signatureImage}" alt="신청자 서명" style="max-width: 200px; max-height: 100px;">
                    </div>
                </div>

                                 <!-- 결재 처리 (현재 사용자가 결재자인 경우만 표시) -->
                <div class="approval-action" th:if="${currentApproverId != null and #strings.equals(loginMember.id, currentApproverId)}">
                    <h3>결재 처리</h3>
                    <form id="approvalForm" class="approval-form">
                        <input type="hidden" id="requestId" th:value="${vacationRequest.id}">
                        <div class="form-group">
                            <label for="comment">결재 의견 <span class="char-count" id="charCount">0/500</span></label>
                            <textarea id="comment" name="comment" rows="4" 
                                      placeholder="결재 의견을 입력하세요 (선택사항, 최대 500자)"
                                      maxlength="500"></textarea>
                        </div>
                        <div class="button-group">
                            <button type="button" class="button primary" onclick="processApproval('APPROVED')">
                                <i class="fas fa-check"></i> 승인
                            </button>
                            <button type="button" class="button danger" onclick="processApproval('REJECTED')">
                                <i class="fas fa-times"></i> 반려
                            </button>
                            <a href="/approval/pending" class="button secondary">
                                <i class="fas fa-list"></i> 목록으로
                            </a>
                        </div>
                    </form>
                </div>

                                 <!-- 현재 결재자가 아닌 경우 -->
                 <div class="approval-info" th:unless="${currentApproverId != null and #strings.equals(loginMember.id, currentApproverId)}">
                    <p>현재 결재 단계가 아닙니다.</p>
                    <a href="/approval/pending" class="button secondary">목록으로</a>
                </div>
            </section>
        </div>
    </div>

    <!-- Sidebar -->
    <div th:replace="~{fragments/sidebar :: #sidebar}"/>
</div>

<!-- Scripts -->
<script th:src="@{/js/jquery.min.js}"></script>
<script th:src="@{/js/bootstrap.bundle.js}"></script>
<script th:src="@{/js/browser.min.js}"></script>
<script th:src="@{/js/breakpoints.min.js}"></script>
<script th:src="@{/js/util.js}"></script>
<script th:src="@{/js/main.js}"></script>
<script th:src="@{/js/logout-confirm.js}"></script>

<script th:src="@{/js/approval-process.js}"></script>

</body>
</html>
