<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: header}" />
<link rel="stylesheet" th:href="@{/css/editorial-form-styles.css}" />
<style>
.signature-canvas {
    border: 2px solid #ddd;
    border-radius: 4px;
    background-color: #fff;
    cursor: crosshair;
    margin-bottom: 10px;
}

.signature-section {
    margin: 20px 0;
}

.signature-section button {
    margin-right: 10px;
}
</style>
</head>
<body>
<div class="main-container">
  <h1>회원가입</h1>

  <form role="form" action="/members/new" th:object="${memberForm}" method="post">

    <!-- 기본 정보 섹션 -->
    <div class="form-section">
      <h3>기본 정보</h3>

      <div class="editorial-row">
        <!-- 아이디 -->
        <div class="editorial-col-6">
          <div class="editorial-form-group">
            <label class="editorial-label" th:for="id">아이디</label>
            <input type="text" th:field="*{id}" id="userIdInput" class="editorial-input" placeholder="아이디를 입력하세요"
                   th:class="${#fields.hasErrors('id')} ? 'editorial-input editorial-field-error' : 'editorial-input'">
            <button type="button" class="editorial-btn secondary" onclick="checkDuplicateId()">중복 확인</button>
            <span id="id-check-result" class="info-message" style="margin-left: 10px;"></span>
            <span class="error-message" th:if="${#fields.hasErrors('id')}" th:errors="*{id}"></span>
          </div>
        </div>

        <!-- 비밀 번호 -->
        <div class="form-section">
          <div class="editorial-row">
            <!-- 비밀번호 -->
            <div class="editorial-col-12">
              <div class="editorial-form-group">
                <label class="editorial-label" th:for="password">패스워드</label>
                <input type="password" th:field="*{password}" class="editorial-input" placeholder="패스워드를 입력하세요"
                       th:class="${#fields.hasErrors('password')} ? 'editorial-input editorial-field-error' : 'editorial-input'">
                <span class="error-message" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- 이름 -->
        <div class="editorial-col-6">
          <div class="editorial-form-group">
            <label class="editorial-label" th:for="name">이름</label>
            <input type="text" th:field="*{name}" class="editorial-input" placeholder="이름을 입력하세요"
                   th:class="${#fields.hasErrors('name')} ? 'editorial-input editorial-field-error' : 'editorial-input'">
            <span class="error-message" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></span>
          </div>
        </div>


      <div class="editorial-row">
        <!-- 전화번호 -->
        <div class="editorial-col-6">
          <div class="editorial-form-group">
            <label class="editorial-label" th:for="phone">전화번호</label>
            <input type="tel" th:field="*{phone}" class="editorial-input" placeholder="전화번호를 입력하세요"
                   th:class="${#fields.hasErrors('phone')} ? 'editorial-input editorial-field-error' : 'editorial-input'">
            <span class="error-message" th:if="${#fields.hasErrors('phone')}" th:errors="*{phone}"></span>
          </div>
        </div>
      </div>
      </div>

    <!-- 주소 정보 섹션 -->
    <div class="form-section">
      <h3>주소 정보</h3>

      <div class="editorial-row">
        <!-- 주소 -->
        <div class="editorial-col-12">
          <div class="editorial-form-group">
            <label class="editorial-label" th:for="address">주소</label>
            <input type="text" th:field="*{address}" class="editorial-input" placeholder="전체 주소를 입력하세요 (예: 서울시 강남구 테헤란로 123)"
            th:class="${#fields.hasErrors('address')} ? 'editorial-input editorial-field-error' : 'editorial-input'">
            <span class="error-message" th:if="${#fields.hasErrors('address')}" th:errors="*{address}"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- 직무 정보 섹션 -->
    <div class="form-section">
      <h3>직무 정보</h3>

      <div class="editorial-row">
        <!-- 부서코드 -->
        <div class="editorial-col-6">
          <div class="editorial-form-group">
            <label class="editorial-label" th:for="deptCode">부서</label>
            <select th:field="*{deptCode}" class="editorial-select"
                    th:classappend="${#fields.hasErrors('deptCode')} ? ' editorial-field-error'">
              <option value="">-- 선택하세요 --</option>
              <option value="im">내과</option>
              <option value="gs">외과</option>
              <option value="ns">신경외과</option>
              <option value="os">정형외과</option>
              <option value="cs">흉부외과</option>
              <option value="ms">진료지원센터</option>
              <option value="si">전략정보실</option>
            </select>
            <span class="error-message" th:if="${#fields.hasErrors('deptCode')}" th:errors="*{deptCode}"></span>
          </div>
        </div>

        <!-- 직급 -->
        <div class="editorial-col-6">
          <div class="editorial-form-group">
            <label class="editorial-label" th:for="jobLevel">직급</label>
            <select th:field="*{jobLevel}" class="editorial-select"
                    th:classappend="${#fields.hasErrors('jobLevel')} ? ' editorial-field-error'">
              <option value="">-- 선택하세요 --</option>
              <option value="1">사원</option>
              <option value="2">부서장</option>
              <option value="3">원장</option>
              <option value="4">진료지원 센터장</option>
              <option value="5">행정원장</option>
              <option value="6">대표원장</option>
              <option value="7">관리자</option>
            </select>
            <span class="error-message" th:if="${#fields.hasErrors('jobLevel')}" th:errors="*{jobLevel}"></span>
          </div>
        </div>
      </div>


    </div>

    <!-- 서명 섹션 -->
    <div class="form-section">
      <h3>서명</h3>

      <div class="signature-section">
        <div class="editorial-form-group">
          <label class="editorial-label">서명을 해주세요</label>
          <canvas id="signature-pad" class="signature-canvas" width="400" height="200"></canvas>
          <input type="hidden" name="signatureData" id="signatureData" />
          <button type="button" class="editorial-btn secondary" onclick="clearSignature()">서명 지우기</button>
          <p id="signature-error" style="color: red; display: none;">서명을 입력해야 회원가입이 가능합니다.</p>
        </div>
      </div>
    </div>

    <!-- 제출 버튼 -->
    <div class="form-actions">
      <button type="submit" class="editorial-btn primary">회원가입</button>
    </div>
  </form>

  <div th:replace="~{fragments/footer :: footer}" />
</div>

<script>
// 서명 캔버스 관련 변수들
let canvas = document.getElementById('signature-pad');
let ctx = canvas.getContext('2d');
let isDrawing = false;
let lastX = 0;
let lastY = 0;

// 캔버스 초기화
ctx.strokeStyle = '#000';
ctx.lineWidth = 2;
ctx.lineCap = 'round';

// 마우스 이벤트
canvas.addEventListener('mousedown', startDrawing);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('mouseup', stopDrawing);
canvas.addEventListener('mouseout', stopDrawing);

// 터치 이벤트 (모바일 지원)
canvas.addEventListener('touchstart', handleTouchStart);
canvas.addEventListener('touchmove', handleTouchMove);
canvas.addEventListener('touchend', stopDrawing);

function startDrawing(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    lastX = e.clientX - rect.left;
    lastY = e.clientY - rect.top;
}

function draw(e) {
    if (!isDrawing) return;
    
    const rect = canvas.getBoundingClientRect();
    const currentX = e.clientX - rect.left;
    const currentY = e.clientY - rect.top;
    
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(currentX, currentY);
    ctx.stroke();
    
    lastX = currentX;
    lastY = currentY;
}

function stopDrawing() {
    isDrawing = false;
    updateSignatureData();
}

function handleTouchStart(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    lastX = touch.clientX - rect.left;
    lastY = touch.clientY - rect.top;
    isDrawing = true;
}

function handleTouchMove(e) {
    e.preventDefault();
    if (!isDrawing) return;
    
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    const currentX = touch.clientX - rect.left;
    const currentY = touch.clientY - rect.top;
    
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(currentX, currentY);
    ctx.stroke();
    
    lastX = currentX;
    lastY = currentY;
}

function clearSignature() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    document.getElementById('signatureData').value = '';
    hideSignatureError();
}

function updateSignatureData() {
    const signatureData = canvas.toDataURL('image/png');
    document.getElementById('signatureData').value = signatureData;
}

// 폼 제출 시 서명 검증
document.querySelector('form').addEventListener('submit', function(e) {
    const signatureData = document.getElementById('signatureData').value;
    if (!signatureData || signatureData.trim() === '') {
        e.preventDefault();
        showSignatureError();
        return false;
    }
    hideSignatureError();
    return true;
});

function showSignatureError() {
    const errorElement = document.getElementById('signature-error');
    errorElement.style.display = 'block';
}

function hideSignatureError() {
    const errorElement = document.getElementById('signature-error');
    errorElement.style.display = 'none';
}
</script>

</body>
</html>